#python my_script.py --ps
#é è¨­ä¸å½±éŸ¿åŸå§‹è¡Œç‚ºï¼Œä¸åŠ  --ps å°±è®“ GPT è‡ªè¡Œæ¢ç´¢ä¸»é¡Œ
#è¼¸å‡ºçš„è³‡æ–™å¤¾æœƒå®Œå…¨ç­‰æ–¼è¼¸å…¥æª”åéœ€æ³¨æ„
import os
from dotenv import load_dotenv
from openai import OpenAI
import argparse
import time
start_time = time.time()
# å‘½ä»¤åˆ—åƒæ•¸è§£æ
parser = argparse.ArgumentParser(description="é€²è¡Œçµæ™¶å¼æ•´ç†")
parser.add_argument("input_file", help="è¼¸å…¥çš„ .txt æª”æ¡ˆï¼Œä¾‹å¦‚ 20250327ä¸‹åˆè’ç ”çµ„_ä¿®æ­£ç‰ˆ.txt")
parser.add_argument("--ps", action="store_true", help="å•Ÿç”¨ presummaryï¼ˆé è¨­ç‚ºé—œé–‰ï¼‰")
args = parser.parse_args()

input_file_path = args.input_file
print("take", input_file_path, "as input file")

# ä¾ç…§ CMD åƒæ•¸æ±ºå®šæ˜¯å¦å•Ÿç”¨ presummary
USE_PRESUMMARY= args.ps


# è¼‰å…¥ç’°å¢ƒè®Šæ•¸
load_dotenv()
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ã€Œå·²æ ¡æ­£ã€çš„æª”æ¡ˆè·¯å¾‘
import os


# å»ºç«‹è³‡æ–™å¤¾å­˜å„²æ¯æ¬¡çš„çµæ™¶çµæœ
folder_name = input_file_path.replace(".txt","")
os.makedirs(folder_name, exist_ok=True)

# æœ€çµ‚çµæ™¶ç¸½çµè¼¸å‡ºæª”
# å–å‡ºåŸå§‹æª”åï¼Œä¸å«è·¯å¾‘
basename = os.path.basename(input_file_path).replace(".txt", ".md")

# çµ„åˆå‡ºæ–°æª”å
finalcrystalname = "final_çµæ™¶ç¸½çµ_" + basename
summary_output_path = os.path.join(folder_name, finalcrystalname)



# è®€å–ä¿®æ­£å¾Œå…§å®¹
with open(input_file_path, "r", encoding="utf-8") as f:
    corrected_content = f.read()

# æ–‡æœ¬é‡ç–Šåˆ†å‰²ç‚º chunks
chunk_size = 2000
overlap_size = 300
text_chunks = []
start = 0

while start < len(corrected_content):
    end = min(start + chunk_size, len(corrected_content))
    text_chunks.append(corrected_content[start:end])
    start += chunk_size - overlap_size

# è‹¥æœ€å¾Œä¸€å€‹chunkå¤ªçŸ­ï¼Œå‰‡åˆä½µå›å‰ä¸€å€‹chunk
if len(text_chunks) > 1:
    last_chunk_len = len(text_chunks[-1])
    # å‡è¨­ä»¥ chunk_size çš„ä¸€åŠç‚ºé–€æª»
    if last_chunk_len < chunk_size * 0.5:
        text_chunks[-2] += text_chunks[-1]
        text_chunks.pop()

# åˆå§‹åŒ–çµæ™¶æ•´ç†çµæœ
crystallized_summary = ""

# å®Œæ•´çš„ç³»çµ±æç¤ºè©ï¼ˆå«è©³ç´°çµæ™¶å¼æ•´ç†æµç¨‹èˆ‡ç¤ºç¯„ç¯„ä¾‹ï¼‰
initial_system_msg = """
ä½ æ˜¯ä¸€å€‹å”åŠ©é€²è¡Œã€çµæ™¶å¼æ•´ç†ã€çš„å°ˆæ¥­AIè¼”åŠ©å·¥å…·ã€‚ä½ çš„ä»»å‹™æ˜¯é€æ­¥é–±è®€å’Œåˆ†æä½¿ç”¨è€…æä¾›çš„é•·ç¯‡æ–‡æœ¬ï¼Œæ¯ä¸€æ¬¡ä½¿ç”¨è€…æœƒæä¾›ä¸€æ®µæ–‡æœ¬ï¼ˆç¨±ç‚ºChunkï¼‰ï¼Œä½ éœ€è¦åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š

çµæ™¶æ³•çš„æ„ç¾©èˆ‡ç”¨é€”ï¼š
ç”±æ–¼å°è©±è¨˜éŒ„å¾ˆé•· ä¸”å£èªå°è«‡ä¸»é¡Œå¯èƒ½å¾ˆåˆ†æ•£ å› æ­¤è¦å‘é•·å‡ºçµæ™¶ä¸€æ¨£ é€å­—é–±è®€æ™‚ æŠŠæ–°çš„é‡è¦ä¸»é¡Œåˆ—ç‚ºæ™¶æ ¸  ç•¶æœ‰å†æ¬¡é–±è®€åˆ°ç›¸é—œä¸»é¡Œæ™‚ è‹¥æœ‰è¿‘ä¸€æ­¥çš„è³‡è¨Šå‰‡æ›´æ–°è“‹ä¸»é¡Œè¨Šæ¯ å¦‚æœå®Œå…¨é‡è¤‡çš„è©±å‰‡ç•¥é å¦‚æœæ˜¯æ–°ä¸»é¡Œå‰‡æ˜¯æ–°çš„æ™¶æ ¸
æœ€çµ‚æ¯å€‹æ™¶æ ¸æ‡‰è©²è¶Šé•·è¶Šå¤šä»¥è±å¯Œåˆå®Œæ•´ä¸”æœ‰æ„ç¾©ç‚ºç›®æ¨™

çµæ™¶å¼æ•´ç†çš„æµç¨‹ï¼š
1. é€è¡Œä»”ç´°é–±è®€æ–‡æœ¬ï¼Œçœ‹åˆ°æ–°ä¸»é¡Œæ™‚å»ºç«‹ä¸€å€‹æ–°ã€Œæ™¶æ ¸ã€ã€‚
2. å†æ¬¡é‡åˆ°ç›¸åŒä¸»é¡Œä¸”æœ‰æ–°è³‡è¨Šæ™‚ï¼Œæ›´æ–°è©²ã€Œæ™¶æ ¸ã€ã€‚
3. è‹¥é‡è¤‡è³‡è¨Šï¼Œèˆ‡èˆŠçš„ç›¸æ¯”é¸æ“‡å¯«å…¥æ›´å…·æœ‰ä»£è¡¨æ€§çš„æˆ–å…©è€…çš†ä¿ç•™ï¼›è‹¥å…¨æ–°ä¸”ä¸å±¬æ–¼ç¾æœ‰ä¸»é¡Œï¼Œå‰‡æ–°å¢æ–°çš„ã€Œæ™¶æ ¸ã€ã€‚
4. ä¸è¦éš¨ä¾¿ç§»é™¤å·²ç¶“é•·å‡ºçš„çµæ™¶çš„å…§å®¹ å°¤å…¶æ˜¯Quotes éƒ¨åˆ†ä¸å¯ä»¥ç§»é™¤ é™¤éé€™å€‹çµæ™¶å®Œå…¨å¯ä»¥å’Œå¦ä¸€å€‹çµæ™¶èåˆ
5. æ¯å€‹æ™¶æ ¸æ‡‰è©²è¶Šé•·è¶Šå¤šï¼Œä»¥è±å¯Œåˆå®Œæ•´ä¸”æœ‰æ„ç¾©çš„é‚„åŸå°Problemçš„æè¿°ç‚ºç›®æ¨™ï¼
ç´€éŒ„æ–¹æ³•ï¼š
- åœ¨æ¯å€‹ä¸»é¡Œä¸‹ï¼Œä½¿ç”¨ Problem / Quotes / Summary çµæ§‹æ­¸ç´ã€‚
- Quotesè¦ç´€éŒ„Speakerä¾‹å¦‚ï¼š[Speaker_03]ã€Œå¯¦éš›ä¸Šä½ çš„æœ¬ä¾†æ˜¯3æœˆ11è™Ÿè¦å®Œæˆï¼Œç¾åœ¨å·²ç¶“æ˜¯4æœˆã€‚ã€

çµæ™¶éç¨‹ç¯„ä¾‹ï¼š

#æ™¶æ ¸ [å°ˆæ¡ˆé€²åº¦èˆ‡çµ„ç¹”åœ–åŒæ­¥]
- ## Problem
  - çµ„ç¹”åœ–çš„åŒæ­¥å»¶é²å°è‡´å°ˆæ¡ˆé€²åº¦çš„å»¶å¾Œã€‚
  - çµ„ç¹”åœ–çš„å°å…¥æ˜¯å°ˆæ¡ˆçš„åŸºæœ¬æ­¥é©Ÿï¼Œç›®å‰åƒ…å®Œæˆ85%ã€‚
  - å°ˆæ¡ˆé€²åº¦å»¶é²ç”±æ–¼åˆä½œå…¬å¸æ–°äººé¡çš„å·¥ç¨‹å¸«æ›´æ›åŠå›è¦†é²ç·©ã€‚
  - é£›é¨°é›²ç«¯ç³»çµ±èˆ‡æ–°äººé¡ç³»çµ±çš„å…¼å®¹å•é¡Œå½±éŸ¿é€²åº¦ã€‚
  
- ## Quotes
  - [Speaker_05]ã€Œç‚ºä»€éº¼çµ„ç¹”åœ–åŒæ­¥æˆ–æ˜¯çµ„ç¹”åœ–æœ¬èº«çš„å°å…¥åˆ°ç¾åœ¨åªå®Œæˆäº†85%ï¼Ÿã€
  - [Speaker_05]ã€Œæ–°äººé¡çš„çµ„ç¹”åœ–å°å…¥å¦‚æœæœªå®Œæˆï¼Œæœƒå½±éŸ¿å¾Œé¢çš„å°ˆæ¡ˆé€²è¡Œã€‚ã€
  - [Speaker_03]ã€Œå¯¦éš›ä¸Šä½ çš„æœ¬ä¾†æ˜¯3æœˆ11è™Ÿè¦å®Œæˆï¼Œç¾åœ¨å·²ç¶“æ˜¯4æœˆã€‚ã€
  - [Speaker_03]ã€Œå› ç‚ºé€™å€‹çœ‹èµ·ä¾†æ˜¯ï¼Œçµ„ç¹”åœ–çš„å°å…¥æ˜¯äº¤çµ¦æ–°äººé¡ï¼Œå•é¡Œæ•´å€‹delayæ˜¯å™ªéŸ³æ–¼æ–°äººé¡ã€‚ã€

  - ## Summary

#æ™¶æ ¸ [å°ˆæ¡ˆé€²åº¦èˆ‡çµ„ç¹”åœ–åŒæ­¥]
- ## Problem
  - çµ„ç¹”åœ–çš„åŒæ­¥å»¶é²å°è‡´å°ˆæ¡ˆé€²åº¦çš„å»¶å¾Œã€‚
  - çµ„ç¹”åœ–çš„å°å…¥æ˜¯å°ˆæ¡ˆçš„åŸºæœ¬æ­¥é©Ÿï¼Œç›®å‰åƒ…å®Œæˆ85%ã€‚
  - å°ˆæ¡ˆé€²åº¦å»¶é²åŸå› åŒ…å«æ–°äººé¡çš„å·¥ç¨‹å¸«æ›´æ›åŠå›è¦†é²ç·©ï¼Œå’Œé£›é¨°é›²ç«¯ç³»çµ±çš„å…§éƒ¨èª¿æ•´ã€‚
  - é£›é¨°é›²ç«¯ç³»çµ±çš„ä¿®æ”¹ä¹ŸåŒæ¨£å½±éŸ¿çµ„ç¹”åœ–é€²åº¦ã€‚
  - çµ„ç¹”åœ–å’Œæµç¨‹çš„é—œè¯æ€§å½±éŸ¿é€²ä¸€æ­¥å°ˆæ¡ˆé€²è¡Œã€‚

- ## Quotes
  - [Speaker_03]ã€Œç‚ºä»€éº¼çµ„ç¹”åœ–åŒæ­¥æˆ–æ˜¯çµ„ç¹”åœ–æœ¬èº«çš„å°å…¥åˆ°ç¾åœ¨åªå®Œæˆäº†85%ï¼Ÿã€
  - [Speaker_03]ã€Œæ–°äººé¡çš„çµ„ç¹”åœ–å°å…¥å¦‚æœæœªå®Œæˆï¼Œæœƒå½±éŸ¿å¾Œé¢çš„å°ˆæ¡ˆé€²è¡Œã€‚ã€
  - [Speaker_03]ã€Œå¯¦éš›ä¸Šä½ çš„æœ¬ä¾†æ˜¯3æœˆ11è™Ÿè¦å®Œæˆï¼Œç¾åœ¨å·²ç¶“æ˜¯4æœˆã€‚ã€
  - [Speaker_03]ã€Œå› ç‚ºé€™å€‹çœ‹èµ·ä¾†æ˜¯ï¼Œçµ„ç¹”åœ–çš„å°å…¥æ˜¯äº¤çµ¦æ–°äººé¡ï¼Œå•é¡Œæ•´å€‹delayæ˜¯å™ªéŸ³æ–¼æ–°äººé¡ã€‚ã€
  - [Speaker_03]ã€Œæ‰€ä»¥ä¸å®Œå…¨å™ªéŸ³æ–¼æ–°äººé¡ï¼Œå› ç‚ºæˆ‘å€‘å°±ç™¼ç¾åˆ°é£›é¨°é›²ç«¯æ²’è¾¦æ³•ç›´æ¥éå»ã€‚ã€
  - [Speaker_04]ã€Œçµ„ç¹”åœ–è¦å…ˆæŠŠhierarchicè¨­å¥½ï¼Œæˆ‘æ‰èƒ½å¾€ä¸‹ï¼Œæµç¨‹æ‰æœ‰è¾¦æ³•å¾€ä¸‹è·‘ã€‚ã€

- ## Summary
  - èˆ‡æ–°äººé¡å…¬å¸å°±å·¥ç¨‹å¸«ç¶“é©—ä¸è¶³å’Œå›è¦†å•é¡Œé€²è¡Œé€²ä¸€æ­¥å”å•†ã€‚
  - èª¿æ•´é£›é¨°é›²ç«¯çš„ç³»çµ±ï¼Œä»¥ä¿ƒé€²èˆ‡æ–°äººé¡ç³»çµ±çš„å…¼å®¹æ€§ã€‚
  - é‚€è«‹ç›¸é—œå…¬å¸é€²è¡Œé¢å°é¢çš„é€²åº¦æª¢è¦–æœƒè­°ï¼ŒåŠ å¿«å•é¡Œè§£æ±ºã€‚
  - é æ¸¬å‰©ä¸‹15%çš„çµ„ç¹”åœ–å°å…¥å·¥ä½œåœ¨æœˆåº•å‰é è¨ˆå®Œæˆã€‚

è«‹æ³¨æ„ï¼š
- Quotes éƒ¨åˆ†åƒ…èƒ½é€šé †åŸè©±èªå¥ï¼Œä¸å¯æ”¹è®ŠåŸè©±å¤ªå¤šã€‚
- æ¯æ¬¡è¼¸å‡ºéƒ½éœ€å®Œæ•´å‘ˆç¾ç›®å‰æ‰€æœ‰ä¸»é¡Œçš„æœ€æ–°æ•´ç†çµæœã€‚
- æœ€çµ‚è¼¸å‡ºçš„æ•´ç†çµæœæ‡‰æ¢ç†æ¸…æ™°ï¼Œæ–¹ä¾¿é«˜å±¤å¿«é€Ÿç†è§£å’ŒæŒæ¡ä¸»é¡ŒåŠå…¶é‡è¦ç´°ç¯€ã€‚
- ä¸è¦éš¨ä¾¿ç§»é™¤å·²ç¶“é•·å‡ºçš„çµæ™¶çš„å…§å®¹ å°¤å…¶æ˜¯Quotes éƒ¨åˆ†ä¸å¯ä»¥ç§»é™¤ é™¤éé€™å€‹çµæ™¶å®Œå…¨å¯ä»¥å’Œå¦ä¸€å€‹çµæ™¶èåˆ
- solutionæ‡‰è©²è¦æ˜¯æª”æ¡ˆä¸­çœŸçš„æœ‰å‡ºç¾çš„å¥å­è€Œä¸”å±¬æ–¼è©²é¡åˆ¥çš„å°æ‡‰è§£æ±ºæ–¹æ¡ˆ
- æ¯å€‹æ™¶æ ¸æ‡‰è©²è¶Šé•·è¶Šå¤šï¼Œä»¥è±å¯Œåˆå®Œæ•´ä¸”æœ‰æ„ç¾©çš„é‚„åŸå°Problemçš„æè¿°ç‚ºç›®æ¨™ï¼
- é™¤äº†ä»¥ä¸Šçµæ™¶çš„è¼¸å‡ºé‚„éœ€è¦é—œæ–¼é€™ä¸€æ®µæ–‡å­—çš„ç¸½çµï¼Œèˆ‡çµæ™¶æ³•ç„¡é—œçš„ä¸€èˆ¬è©³ç´°ç¸½çµï¼Œå¹«åŠ©åˆ¥äººç«‹åˆ»äº†è§£é€™å€‹æ®µè½çš„è©³ç´°å…§å®¹ã€‚

"""



# é è¨­çš„åˆå§‹æ™¶æ ¸æ¸…å–®ï¼ˆå¯æ‰‹å‹•ç·¨è¼¯ï¼‰é€™åˆ†æ¸…å–®å»ºè­°è®“notebookLMæ•´ç†
presummary = """
é€™è£¡æ˜¯å·²ç¶“æ•´ç†éçš„æ°ç•¶çš„å…¨æ–‡ä»¶ä¸»é¡Œæ¸…å–®(åˆå§‹æ™¶æ ¸)ï¼š

"""

# é‡å°ç¬¬ä¸€å€‹ chunk çš„è™•ç†æ–¹å¼ï¼Œæ ¹æ“š USE_PRESUMMARY æ˜¯å¦å•Ÿç”¨
def get_prompt_for_first_chunk(chunk):
    if USE_PRESUMMARY:
        print("Using_PRESUMMARY")
        # ä½¿ç”¨ presummary ä½œç‚ºã€Œå·²å­˜åœ¨çš„çµæ™¶å¼æ•´ç†çµæœã€
        return f"""
é€™æ˜¯å·²ç¶“å­˜åœ¨çš„çµæ™¶å¼æ•´ç†çµæœ (presummary)ï¼š
==================
{presummary}
==================

ç¾åœ¨è«‹ä½ ä»¥æ­¤ç‚ºåŸºç¤ï¼Œä¸¦æ ¹æ“šä¸‹æ–¹æ–‡æœ¬æ›´æ–°æˆ–æ–°å¢ä¸»é¡Œ/æ™¶æ ¸ï¼Œä¿æŒåŸæœ‰æ¸…å–®åŒæ™‚é€²è¡Œçµæ™¶ï¼š

æ–‡æœ¬å…§å®¹ (Chunk #1)ï¼š
{chunk}
"""
    else:
        # ä¸å•Ÿå‹• presummaryï¼Œä½¿ç”¨åŸå§‹æµç¨‹
        return f"""
é€™æ˜¯ç¬¬ä¸€å€‹Chunkï¼Œè«‹ä¾ç…§çµæ™¶å¼æ•´ç†æ­¥é©Ÿå»ºç«‹åˆå§‹ä¸»é¡Œæ•´ç†ï¼š

æ–‡æœ¬å…§å®¹ (Chunk #1)ï¼š
{chunk}
"""




def get_prompt_for_next_chunk(prev_summary, new_chunk_text, chunk_index):
    return f"""
é€™æ˜¯ä¸Šä¸€è¼ªçš„çµæ™¶å¼æ•´ç†çµæœï¼š
==================
{prev_summary}
==================

ç¾åœ¨æœ‰æ–°çš„æ–‡æœ¬ (Chunk #{chunk_index+1})ï¼Œè«‹ä¿ç•™èˆŠä¸»é¡Œçš„åŒæ™‚æ ¹æ“šæ–°å…§å®¹æ›´æ–°ä¸»é¡Œåç¨±æˆ–æ–°å¢ä¸»é¡Œï¼Œç¢ºä¿æ¯å€‹ä¸»é¡Œå‡åŒ…å«Problemã€Quotesï¼Œä»¥åŠSolutionï¼ˆå¦‚é©ç”¨ï¼‰ ä¸¦åœ¨æœ€å¾Œä¸€æ¨£çµ¦å‡ºèˆ‡çµæ™¶æ³•ç„¡é—œçš„ç¸½çµï¼š

æ–°çš„æ–‡æœ¬å…§å®¹ï¼š
{new_chunk_text}

è«‹æ³¨æ„ï¼š
- Quotes éƒ¨åˆ†åƒ…èƒ½é€šé †åŸè©±èªå¥ï¼Œä¸å¯æ”¹è®ŠåŸè©±å¤ªå¤šã€‚
- æ¯æ¬¡è¼¸å‡ºéƒ½éœ€å®Œæ•´å‘ˆç¾ç›®å‰æ‰€æœ‰ä¸»é¡Œçš„æœ€æ–°æ•´ç†çµæœã€‚
- æœ€çµ‚è¼¸å‡ºçš„æ•´ç†çµæœæ‡‰æ¢ç†æ¸…æ™°ï¼Œæ–¹ä¾¿é«˜å±¤å¿«é€Ÿç†è§£å’ŒæŒæ¡ä¸»é¡ŒåŠå…¶é‡è¦ç´°ç¯€ã€‚
- ä¸è¦éš¨ä¾¿ç§»é™¤å·²ç¶“é•·å‡ºçš„çµæ™¶çš„å…§å®¹ å°¤å…¶æ˜¯Quotes éƒ¨åˆ†ä¸å¯ä»¥ç§»é™¤ é™¤éé€™å€‹çµæ™¶å®Œå…¨å¯ä»¥å’Œå¦ä¸€å€‹çµæ™¶èåˆ
- solutionæ‡‰è©²è¦æ˜¯æª”æ¡ˆä¸­çœŸçš„æœ‰å‡ºç¾çš„å¥å­è€Œä¸”å±¬æ–¼è©²é¡åˆ¥çš„å°æ‡‰è§£æ±ºæ–¹æ¡ˆ
- æ¯å€‹æ™¶æ ¸æ‡‰è©²è¶Šé•·è¶Šå¤šï¼Œä»¥è±å¯Œåˆå®Œæ•´ä¸”æœ‰æ„ç¾©çš„é‚„åŸå°Problemçš„æè¿°ç‚ºç›®æ¨™ï¼
- é™¤äº†ä»¥ä¸Šçµæ™¶çš„è¼¸å‡ºé‚„éœ€è¦é—œæ–¼é€™ä¸€æ®µæ–‡å­—çš„ç¸½çµï¼Œèˆ‡çµæ™¶æ³•ç„¡é—œçš„ä¸€èˆ¬è©³ç´°ç¸½çµï¼Œå¹«åŠ©åˆ¥äººç«‹åˆ»äº†è§£é€™å€‹æ®µè½çš„è©³ç´°å…§å®¹ã€‚

"""

# è™•ç†æ¯å€‹ Chunk
# è™•ç†æ¯å€‹ Chunk
for idx, chunk in enumerate(text_chunks):
    print(f"æ­£åœ¨è™•ç†ç¬¬ {idx+1}/{len(text_chunks)} å€‹ Chunk...")

    if idx == 0:
        user_prompt = get_prompt_for_first_chunk(chunk)
    else:
        user_prompt = get_prompt_for_next_chunk(crystallized_summary, chunk, idx)

    messages = [
        {"role": "system", "content": initial_system_msg},
        {"role": "user", "content": user_prompt}
    ]

    response = client.chat.completions.create(
        model="gpt-4o",
        messages=messages
    )

    updated_summary = response.choices[0].message.content
    crystallized_summary = updated_summary

    evolving_filename = os.path.join(folder_name, f"crystallized_after_chunk_{idx+1}.md")
    with open(evolving_filename, "w", encoding="utf-8") as f:
        f.write(crystallized_summary)

    print(f"å·²å°‡ç¬¬ {idx+1} å€‹ Chunk çš„çµæ™¶å¾Œç‹€æ…‹å­˜å…¥ {evolving_filename}")

# ==============================
# æœ€çµ‚çµæ™¶ç¸½çµéšæ®µ
# ==============================

# è®€å–æ‰€æœ‰ chunk çš„ä¸­é–“è¼¸å‡ºæ–‡ä»¶
all_summaries = []
for idx in range(1, len(text_chunks) + 1):
    intermediate_filename = os.path.join(folder_name, f"crystallized_after_chunk_{idx}.md")
    with open(intermediate_filename, "r", encoding="utf-8") as f:
        all_summaries.append(f.read())

# åˆä½µæ‰€æœ‰ summary ç‚ºæœ€çµ‚ç¸½çµçš„è¼¸å…¥
# å…ˆè¨ˆç®—æ‰€æœ‰çµæ™¶æ®µè½åˆä½µçµæœ
combined_summaries = "\n".join(all_summaries)

# æ§‹å»ºæœ€çµ‚ç¸½çµçš„ Prompt
final_summary_prompt = (
    "ä»¥ä¸‹æ˜¯æ‰€æœ‰åˆ†æ®µè™•ç†å¾Œçš„çµæ™¶çµæœï¼Œè«‹ä½ æ•´åˆä¸¦ç”¢å‡ºæœ€çµ‚å®Œæ•´ç¸½çµï¼š\n"
    "=========================\n"
    f"{combined_summaries}\n"
    "=========================\n"
    "è«‹ç¢ºä¿ï¼š\n"
    "- å…§å®¹æ¢ç†æ¸…æ™°ï¼Œåˆä½µé‡è¤‡æ™¶æ ¸Quotesèˆ‡ä½†ä¿ç•™æ‰€æœ‰é‡è¦è³‡è¨Šã€‚\n"
    "- ä¸è¦éºæ¼ä»»ä½•ä¸»é¡Œï¼Œç¢ºä¿æ‰€æœ‰ä¸»é¡Œéƒ½æœ‰å®Œæ•´çš„å•é¡Œ (Problem)ã€å¼•ç”¨ (Quotes) å’Œè§£æ±ºæ–¹æ¡ˆ (Solution)ã€‚\n"
    "- é¸æ“‡æœ€å…·ä»£è¡¨æ€§è·Ÿä¸»é¡Œé—œè¯ä¸”è³‡è¨Šæ˜ç¢ºçš„ Quotesï¼Œä¸¦æ ¹æ“šæ‰€æœ‰æ®µè½é€²è¡Œæ­¸ç´æ•´ç†ã€‚\n"
    "- å°‡â€œæ™¶æ ¸â€é€™å€‹æ–‡å­—æ”¹æˆ â€œè¨è«–ä¸»é¡Œâ€ã€‚\n"
    "- è«‹åœ¨æœ€çµ‚å¯«å‡ºä¸€ä»½å®Œæ•´çš„çµ¦é«˜å±¤çœ‹çš„æœƒè­°å ±å‘Šã€‚\n"
    
)



# å‘¼å« GPT é€²è¡Œæœ€çµ‚ç¸½çµ
messages = [
    {"role": "system", "content": initial_system_msg},
    {"role": "user", "content": final_summary_prompt}
]

response = client.chat.completions.create(
    model="gpt-4o",
    messages=messages
)

final_summary = response.choices[0].message.content

# å°‡æœ€çµ‚ç¸½çµçµæœå­˜å…¥ summary_output_path
with open(summary_output_path, "w", encoding="utf-8") as f:
    f.write(final_summary)

print(f"æœ€çµ‚çµæ™¶æ•´ç†å·²å®Œæˆï¼Œå­˜æ”¾æ–¼ {summary_output_path}")
end_time = time.time()
elapsed_time = end_time - start_time
print(f"ğŸš€ ç¸½åŸ·è¡Œæ™‚é–“ï¼š{elapsed_time:.2f} ç§’")